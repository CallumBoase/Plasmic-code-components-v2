<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Resumable Upload Supabase + UppyJS</title>
    <link href="https://releases.transloadit.com/uppy/v3.6.1/uppy.min.css" rel="stylesheet" />

    <style>
      html {
        background: #9e44ef;
      }
      body {
        height: 100vh;
        background: radial-gradient(72.03% 66.03% at 50% 69.72%, #dbb8bf 0, transparent 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      a {
        display: block;
        margin: 10px;
        text-decoration: none;
      }
      #logo {
        max-width: 150px;
      }
      #drag-drop-area {
        margin-top: 40px;
      }
    </style>
  </head>
  <body>
    <img id="logo" src="supabase-logo-wordmark--dark.png" />
    <div id="drag-drop-area"></div>
    <a href="https://supabase.com/docs/guides/storage/uploads/resumable-uploads" target="_blank"
      >Read the docs.</a
    >

    <script type="module">
      import {
        Uppy,
        Dashboard,
        Tus,
      } from 'https://releases.transloadit.com/uppy/v3.6.1/uppy.min.mjs'

      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5cG14Y2J1aHdwdWt6bW94aGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTQwNTExNjksImV4cCI6MjAwOTYyNzE2OX0.t_awsVzBc-Nyoe6ZfYTVZ-CCCQXmRVYuSmoUNJGim_Q'
      const SUPABASE_PROJECT_ID = 'gypmxcbuhwpukzmoxhds'
      const STORAGE_BUCKET = 'temp_public'
      const BEARER_TOKEN='eyJhbGciOiJIUzI1NiIsImtpZCI6IjYyWEd4RUsxY09ZVFBGcmIiLCJ0eXAiOiJKV1QifQ.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzEwNzkyNDkyLCJpYXQiOjE3MTA3ODg4OTIsImlzcyI6Imh0dHBzOi8vZ3lwbXhjYnVod3B1a3ptb3hoZHMuc3VwYWJhc2UuY28vYXV0aC92MSIsInN1YiI6IjdhNDFkNTYxLWI1OTYtNGI2MS04NjBjLTY5MDhhMGYxYTU3OSIsImVtYWlsIjoiY2FsbHVtLmJvYXNlQGdtYWlsLmNvbSIsInBob25lIjoiIiwiYXBwX21ldGFkYXRhIjp7InByb3ZpZGVyIjoiZW1haWwiLCJwcm92aWRlcnMiOlsiZW1haWwiXX0sInVzZXJfbWV0YWRhdGEiOnt9LCJyb2xlIjoiYXV0aGVudGljYXRlZCIsImFhbCI6ImFhbDEiLCJhbXIiOlt7Im1ldGhvZCI6InBhc3N3b3JkIiwidGltZXN0YW1wIjoxNzEwNzg4ODkyfV0sInNlc3Npb25faWQiOiJhZmNhMWMxOC0zZjUyLTRhNzYtOTM4OS0wMGMwMjE4ZGM1MGYiLCJpc19hbm9ueW1vdXMiOmZhbHNlfQ.ShJp7H_B5iMGGnlIRZQ4fHFtG0DWxkjOxxHpXY-JMMQ'

      const folder = 'fromUppy'
      const supabaseStorageURL = `https://${SUPABASE_PROJECT_ID}.supabase.co/storage/v1/upload/resumable`

      var uppy = new Uppy()
        .use(Dashboard, {
          inline: true,
          limit: 10,
          target: '#drag-drop-area',
          showProgressDetails: true,
          showRemoveButtonAfterComplete: true
        })
        .use(Tus, {
          endpoint: supabaseStorageURL,
          headers: {
            authorization: `Bearer ${BEARER_TOKEN}`,
            apikey: SUPABASE_ANON_KEY,
          },
          uploadDataDuringCreation: true,
          chunkSize: 6 * 1024 * 1024,
          allowedMetaFields: ['bucketName', 'objectName', 'contentType', 'cacheControl'],
          onError: function (error) {
            console.log('Failed because: ' + error)
          },
        })

      uppy.on('file-added', (file) => {
        const supabaseMetadata = {
          bucketName: STORAGE_BUCKET,
          objectName: folder ? `${folder}/${file.name}` : file.name,
          contentType: file.type,
        }

        file.meta = {
          ...file.meta,
          ...supabaseMetadata,
        }

        console.log('file added', file)
      })

      uppy.on('complete', (result) => {
        console.log('Upload complete! Weâ€™ve uploaded these files:', result.successful)
        console.log(result);
      })

      //Not yet working
      uppy.on('file-removed', (file, reason) => {
        if(reason === 'removed-by-user') {
          console.log('file removed by user', file)
          //Send delete request using supabasejs
        }
        
      })

    </script>
  </body>
</html>