# Notes for SupabaseUppyUploader

## Note 1: explanation of `onBeforeFileAdded` handler

In `index.tsx`, we specific a custom `onBeforeFileAdded` handler.
This is called before a file is added to Uppy.

We use this function to
1. add metadata required by Supabase Storage when uploading via uppy Tus plugin (`bucketName`, `objectName` and `contentType`)
2. Custom check for identical files in this Uppy instance (more info below on why we have to run a custom check)
3. Allow the user to change the filename (add a UID at the front) or put the file in a unique folder (add a UID to the path)

### UID in filename or path - explanation & notes (and why we have to run custom check for identical files in Uppy instance)

Why give the option of adding uid to filename or path? 

Because Supabase storage will error if two users upload a file to the exact same path (eg same filename), and this is not desirable behaviour in some cases, eg when running a multi-tentant app where everyone uses the same bucket for storage.

By adding a uid in one of the above 2 ways, we remove this problem and allow multiple identical files to be uploaded without conflict.

However, to make this work as expected, when adding a uid to filename or adding files in a uid folder, we need to override the default uppy-generated file.id with our own file.id

Reason: Uppy generates it's own file.id based on the file name & a few other things. This Uppy-generated ID will always be the same for the same file from the same source.
Uppy.Tus plugin uses file.id (which is usually the uppy-generated one) to identify the file on the Supabase Storage server. 
If the user uploads a file (filename.jpg), (using a different Uppy instance) later uploads the same file (filename.jpg) 
the existing file will be resumed (even if already finished) rather than a new being created again on the server.
(This is usually desirable behaviour for resuamble uploads, because it allows an upload to resume at a later stage.)

However it's not what we are wanting when choosing to add uid to filename or putting files in their own unique folder. 
So to prevent this, we change the uppy-generated ID to our uid.
This causes Uppy to consider the file as a new file, and upload it again under a unique name, rather than resuming the existing one.

The resumable upload behaviour based on Uppy-generated ID also causes problems when we rename a file before upload, because Supabase storage does not return the path of a file after upload. Since each time a file is added to Uppy we generate a new UID, this can lead to mis-matches between the path of the file in the server, and the path that Uppy THINKS it is stored at. 

Here's how that arises
1. User uploads file1.jpg via Uppy & Tus. 
  We auto-set the filename to uid1_file1.jpg, but file.id generated by uppy is unchanged.
2. This file is uploaded to Supabase Storage, identified by the Uppy-generated ID, and stored as uid1_file1.jpg. The file upload finishes.
  Uppy reports that the successfuly uploaded file is stored at somebucket/uid1_file1.jpg (all OK so far)
3. User refreshes the page with Uppy on it
4. User selects file1.jpg again. We auto-set the filename, this time to uid2_file1.jpg, but the uppy generated file.id is the same as in (1)
5. Uppy identifies the file by it's uppy-generated ID to Supabase Storage. Supabase storage sees the file is already there and
  reports that upload is complete (since it previously did) and does NOT return the filename uid1_file1.jpg
  Uppy reports that the file has finished, and thinks it's path is somebucket/uid2_file1.jpg (INCORRECT!)
  Supabase storage does not return the filepath, so we have no way of overriding what Uppy reports as the successfully uploaded filepath
7. If we store uid2_file1.jpg and later try to run an API call to download it, the API call will fail, 
  because the file is actually stored as uid1_file1.jpg!

To fix these issues, we override the file.id generated by Uppy with our own ID, and store the original Uppy-generated ID in file.meta
Here's the scenario again

Here's how that process now looks
1. User uploads file1.jpg via Uppy & Tus. 
  We auto-set the filename to uid1_file1.jpg, and file.id to uid1.
2. This file is uploaded to Supabase Storage, identified by id uid1, and stored as uid1_file1.jpg. The file upload finishes.
  Uppy reports that the successfuly uploaded file is stored at somebucket/uid1_file1.jpg (all OK so far)
3. User refreshes the page with Uppy on it
4. User selects file1.jpg again. We auto-set the filename, this time to uid2_file1.jpg, and id to uid2.
5. When upload starts, Supabase Storage sees that there's no file with id uid2 so a new upload starts, then finishes
  Uppy reports that the successfuly uploaded file is stored at somebucket/uid2_file1.jpg (GOOD)
  We also have two versions of the file stored on the server without conflict: uid1_file1.jpg and uid2_file1.jpg (GOOD)


This is good, but one problem remains:
Uppy prevents the user selecting identical files in THE SAME Uppy instance by it's file.id, which is desirble
Eg 
1. User opens a page with Uppy on it
2. They select file1.jpg and it's added to the Uppy queue
3. They "add more files" and select file1.jpg AGAIN

The expected behaviour is that file1.jpg will NOT be added to the queue twice, because Uppy sees that the file.id is the same
This works well by default, until we start messing with the file.id

In order to prevent the user adding the same file to an Uppy instance twice, we store the original Uppy-generated ID in file.meta and run a custom
check beforeFileUpload to prevent adding the same file twice